#!/bin/bash

# Copyright (C) 2017-2018 Andrei Pavel, andrei.pavel@cti.pub.ro
# Licensed under the MIT License

# Get script path.
script_path="$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")"

# Header
. "${script_path}/header"
. "${script_path}/spinner"

function confirm() {
  # call with a prompt string or use a default
  read -r -p "${1:-Are you sure? [y/N]} " response
  case "$response" in
    [yY][eE][sS]|[yY])
      true
      ;;
    *)
      false
      ;;
  esac
}

function mandatory() {
  while (( ${#} > 0 )); do
    if [[ -z ${!1} ]]; then
      printf "${RED}%s${RESET} argument is mandatory.\\n" "${1}" >&2
      printUsage
      exit 2
    fi
    shift
  done
}

function start_spinner() {
  if [[ ${-} == *x* ]]; then
    return
  fi
  local message="${1}"
  printf "%s%$(($(tput cols)-${#message}-8))s" "${message}"
  _spinner 'start' &
  _spinner_pid="${!}"
  disown
}

function stop_spinner() {
  local exit_status="${1}"
  _spinner 'stop' "${exit_status}" "${_spinner_pid}"
  unset _spinner_pid
}

# Traps
for t in HUP INT QUIT KILL TERM EXIT; do
  trap "\
    return_code=\${?}
    trap - EXIT
    stop_spinner
    printf \"${t} %s\\n\" \"\${return_code}\" 1>&2
    exit \${return_code}
  " ${t}
done
